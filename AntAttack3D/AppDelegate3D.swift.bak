import UIKit
import SceneKit
import os.log

// File logging helper
class FileLogger {
    static let shared = FileLogger()
    private let logFile: URL
    
    init() {
        let documentsPath = FileManager.default.urls(for: .documentDirectory, in: .userDomainMask)[0]
        logFile = documentsPath.appendingPathComponent("app_debug.log")
        
        // Create or append to log file
        if !FileManager.default.fileExists(atPath: logFile.path) {
            FileManager.default.createFile(atPath: logFile.path, contents: nil, attributes: nil)
        }
        
        log("========================================")
        log("NEW SESSION STARTED")
        log("Log file: \(logFile.path)")
        log("========================================")
    }
    
    func log(_ message: String) {
        let timestamp = Date()
        let logMessage = "[\(timestamp)] \(message)\n"
        
        // Print to console
        print(logMessage)
        NSLog("%@", logMessage)
        
        // Write to file
        if let data = logMessage.data(using: .utf8) {
            if let fileHandle = try? FileHandle(forWritingTo: logFile) {
                fileHandle.seekToEndOfFile()
                fileHandle.write(data)
                fileHandle.closeFile()
            }
        }
    }
    
    func getLogPath() -> String {
        return logFile.path
    }
}

@main
class AppDelegate: UIResponder, UIApplicationDelegate {
    
    var window: UIWindow?
    
    func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -> Bool {
        // Start file logging immediately
        FileLogger.shared.log("ğŸš€ APP LAUNCHED - AppDelegate.application(_:didFinishLaunchingWithOptions:)")
        FileLogger.shared.log("ğŸš€ Using triple logging: print + NSLog + file")
        
        print("========================================")
        print("ğŸš€ APP LAUNCHED - AppDelegate starting")
        print("========================================")
        NSLog("ğŸš€ APP LAUNCHED - AppDelegate starting")
        os_log("ğŸš€ APP LAUNCHED - AppDelegate starting", type: .error)
        
        FileLogger.shared.log("âœ… Creating UIWindow")
        
        // Create window programmatically
        window = UIWindow(frame: UIScreen.main.bounds)
        print("âœ… Window created: \(UIScreen.main.bounds)")
        NSLog("âœ… Window created")
        FileLogger.shared.log("âœ… Window created: \(UIScreen.main.bounds)")
        
        FileLogger.shared.log("âœ… Creating MainNavigationController")
        
        // Create the navigation controller for scene transitions
        let mainNavController = MainNavigationController()
        window?.rootViewController = mainNavController
        print("âœ… View controller set: MainNavigationController")
        NSLog("âœ… View controller set: MainNavigationController")
        FileLogger.shared.log("âœ… View controller set")
        
        window?.makeKeyAndVisible()
        print("âœ… Window made visible")
        print("========================================")
        NSLog("âœ… Window made visible - App ready")
        FileLogger.shared.log("âœ… Window made visible - App ready")
        FileLogger.shared.log("ğŸ“ Log file location: \(FileLogger.shared.getLogPath())")
        
        // Initialize Game Center immediately at app launch
        print("ğŸ® Initializing Game Center...")
        FileLogger.shared.log("ğŸ® Initializing Game Center...")
        _ = GameCenterManager.shared
        
        return true
    }
}
